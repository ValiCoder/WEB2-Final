<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Dashboard</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    .columns { display:flex; gap:24px; }
    .panel { flex:1; border:1px solid #ddd; padding:12px; border-radius:6px; }
    table { width:100%; border-collapse:collapse; }
    th,td { padding:8px; border-bottom:1px solid #eee; text-align:left }
  </style>
</head>
<body>
  <div class="container">
    <h1>Dashboard</h1>
    <p id="who"></p>
    <div class="columns">
      <div class="panel">
        <h2>Users</h2>
        <div id="usersArea">Loading...</div>
      </div>
      <div class="panel">
        <h2>Courses</h2>
        <div id="coursesArea">Loading...</div>
        <div id="createCourseArea"></div>
          <div id="lessonsPanel" style="margin-top:32px;"></div>
      </div>
    </div>
    <p><a href="/user">My profile</a> — <a href="/logout">Logout</a></p>
  </div>

  <script>
    async function load() {
      const whoEl = document.getElementById('who');
      const usersArea = document.getElementById('usersArea');
      const coursesArea = document.getElementById('coursesArea');

        // lessons panel
        const lessonsPanel = document.getElementById('lessonsPanel');
        lessonsPanel.innerHTML = '';

      // get current user
      const meRes = await fetch('/api/me');
      if (!meRes.ok) {
        window.location = '/login';
        return;
      }
      const me = await meRes.json();
      whoEl.textContent = `Signed in as ${me.name} (${me.email}) — role: ${me.role}`;

      // fetch users (may be forbidden for non-admin)
      const usersRes = await fetch('/api/users');
      if (usersRes.ok) {
        const users = await usersRes.json();
        usersArea.innerHTML = renderUsers(users);
      } else if (usersRes.status === 403) {
        usersArea.innerHTML = '<p class="error">You do not have permission to view all users.</p>';
      } else {
        usersArea.innerHTML = '<p class="error">Error loading users</p>';
      }

      // fetch courses
      const coursesRes = await fetch('/api/courses');
      if (coursesRes.ok) {
        const courses = await coursesRes.json();
        coursesArea.innerHTML = renderCourses(courses, me);

          // Добавить обработчик выбора курса для отображения уроков
          coursesArea.querySelectorAll('tr').forEach((row, idx) => {
            if (idx === 0) return; // skip header
            row.addEventListener('click', () => showLessons(courses[idx-1], me));
          });
      } else {
        coursesArea.innerHTML = '<p class="error">Error loading courses</p>';
      }

      // show course creation form for teachers/admins
      const createArea = document.getElementById('createCourseArea');
      if (me.role === 'teacher' || me.role === 'admin') {
        createArea.innerHTML = `
          <hr>
          <h3>Create Course</h3>
          <form id="createCourseForm">
            <div><input name="name" placeholder="Course name" required></div>
            <div><input name="topic" placeholder="Topic"></div>
            <div><button type="submit">Create</button></div>
          </form>
          <div id="createResult"></div>
        `;
        document.getElementById('createCourseForm').addEventListener('submit', async (e) => {
          e.preventDefault();
          const fd = new FormData(e.target);
          const body = { name: fd.get('name'), topic: fd.get('topic') };
          const r = await fetch('/api/courses', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
          const res = document.getElementById('createResult');
          if (r.ok) { res.innerHTML = '<p>Course created.</p>'; e.target.reset(); load(); } else { res.innerHTML = '<p class="error">Failed to create</p>'; }
        });
      } else {
        createArea.innerHTML = '';
      }
    }

    function renderUsers(users) {
      if (!users || users.length === 0) return '<p>No users found.</p>';
      return `
        <table>
          <thead><tr><th>Name</th><th>Email</th><th>Role</th></tr></thead>
          <tbody>
            ${users.map(u => `<tr><td>${escape(u.name)}</td><td>${escape(u.email)}</td><td>${escape(u.role||'user')}</td></tr>`).join('')}
          </tbody>
        </table>
      `;
    }

    function renderCourses(courses, me) {
      if (!courses || courses.length === 0) return '<p>No courses found.</p>';
      return `
        <table>
          <thead><tr><th>Name</th><th>Topic</th><th>Owner</th><th>Actions</th></tr></thead>
          <tbody>
            ${courses.map(c => `
              <tr>
                <td>${escape(c.name)}</td>
                <td>${escape(c.topic||'')}</td>
                <td>${escape((c.owner && (c.owner.name || c.owner.email)) || c.owner)}</td>
                <td>${canEdit(c, me) ? `<button onclick="editCourse('${c.id}')">Edit</button> <button onclick="deleteCourse('${c.id}')">Delete</button>` : 'N/A'}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function canEdit(course, me) {
      return me.role === 'admin' || (course.owner && String(course.owner._id || course.owner.id) === String(me.id));
    }

    async function editCourse(courseId) {
      const coursesRes = await fetch('/api/courses');
      const courses = await coursesRes.json();
      const course = courses.find(c => c.id === courseId);
      if (!course) return alert('Course not found');
      const name = prompt('Course name:', course.name);
      if (name === null) return;
      const topic = prompt('Topic:', course.topic || '');
      const r = await fetch(`/api/courses/${courseId}`, {
        method: 'PUT',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({name, topic})
      });
      if (r.ok) { alert('Updated'); load(); } else { alert('Failed'); }
    }

    async function deleteCourse(courseId) {
      if (!confirm('Delete this course?')) return;
      const r = await fetch(`/api/courses/${courseId}`, { method: 'DELETE' });
      if (r.ok) { alert('Deleted'); load(); } else { alert('Failed'); }
    }

    window.editCourse = editCourse;
    window.deleteCourse = deleteCourse;

      async function showLessons(course, me) {
        lessonsPanel.innerHTML = `<h3>Lessons for: ${escape(course.name)}</h3><div id="lessonsArea">Loading...</div>`;
        const lessonsArea = document.getElementById('lessonsArea');
        // fetch lessons
        const r = await fetch(`/api/lessons?course=${course.id}`);
        if (!r.ok) { lessonsArea.innerHTML = '<p class="error">Failed to load lessons</p>'; return; }
        const lessons = await r.json();
        lessonsArea.innerHTML = renderLessons(lessons, me, course);

        // show lesson creation form for teachers/admins
        if (me.role === 'teacher' || me.role === 'admin') {
          lessonsArea.innerHTML += `
            <hr>
            <h4>Add Lesson</h4>
            <form id="createLessonForm">
              <div><input name="title" placeholder="Lesson title" required></div>
              <div><textarea name="content" placeholder="Lesson content" required></textarea></div>
              <div><select name="type">
                <option value="text">Text</option>
                <option value="video">Video</option>
                <option value="document">Document</option>
                <option value="quiz">Quiz</option>
              </select></div>
              <div><input name="order" type="number" min="1" placeholder="Order (1,2...)" required></div>
              <div><input name="videoUrl" placeholder="Video URL (optional)"></div>
              <div><input name="attachments" placeholder="Attachments (comma separated URLs)"></div>
              <div><input name="duration" type="number" min="1" placeholder="Duration (min, optional)"></div>
              <div><button type="submit">Add Lesson</button></div>
            </form>
            <div id="createLessonResult"></div>
          `;
          document.getElementById('createLessonForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const fd = new FormData(e.target);
            const body = {
              title: fd.get('title'),
              content: fd.get('content'),
              type: fd.get('type'),
              order: Number(fd.get('order')),
              course: course.id,
              videoUrl: fd.get('videoUrl'),
              attachments: fd.get('attachments') ? fd.get('attachments').split(',').map(s=>s.trim()).filter(Boolean) : [],
              duration: fd.get('duration') ? Number(fd.get('duration')) : undefined
            };
            const r = await fetch('/api/lessons', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
            const res = document.getElementById('createLessonResult');
            if (r.ok) { res.innerHTML = '<p>Lesson created.</p>'; e.target.reset(); showLessons(course, me); } else { res.innerHTML = '<p class="error">Failed to create</p>'; }
          });
        }
      }

      function renderLessons(lessons, me, course) {
        if (!lessons || lessons.length === 0) return '<p>No lessons found.</p>';
        return `
          <table>
            <thead><tr><th>Order</th><th>Title</th><th>Type</th><th>Actions</th></tr></thead>
            <tbody>
              ${lessons.map(l => `
                <tr>
                  <td>${escape(l.order)}</td>
                  <td>${escape(l.title)}</td>
                  <td>${escape(l.type)}</td>
                  <td>${canEditLesson(l, me) ? `<button onclick="editLesson('${l._id}','${course.id}')">Edit</button> <button onclick="deleteLesson('${l._id}','${course.id}')">Delete</button>` : 'N/A'}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      }

      function canEditLesson(lesson, me) {
        return me.role === 'admin' || String(lesson.owner) === String(me.id);
      }

      window.editLesson = async function(lessonId, courseId) {
        const r = await fetch(`/api/lessons/${lessonId}`);
        if (!r.ok) return alert('Lesson not found');
        const lesson = await r.json();
        const title = prompt('Lesson title:', lesson.title);
        if (title === null) return;
        const content = prompt('Content:', lesson.content);
        const type = prompt('Type (text,video,document,quiz):', lesson.type);
        const order = prompt('Order:', lesson.order);
        const videoUrl = prompt('Video URL:', lesson.videoUrl||'');
        const attachments = prompt('Attachments (comma separated URLs):', (lesson.attachments||[]).join(','));
        const duration = prompt('Duration (min):', lesson.duration||'');
        const body = { title, content, type, order:Number(order), videoUrl, attachments:attachments?attachments.split(',').map(s=>s.trim()).filter(Boolean):[], duration:duration?Number(duration):undefined };
        const resp = await fetch(`/api/lessons/${lessonId}`, { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
        if (resp.ok) { alert('Updated'); showLessons({id:courseId}, {id:lesson.owner,role:'admin'}); } else { alert('Failed'); }
      }

      window.deleteLesson = async function(lessonId, courseId) {
        if (!confirm('Delete this lesson?')) return;
        const r = await fetch(`/api/lessons/${lessonId}`, { method: 'DELETE' });
        if (r.ok) { alert('Deleted'); showLessons({id:courseId}, {id:''}); } else { alert('Failed'); }
      }

    function escape(s){ return String(s||'').replace(/[&<>"']/g, function(ch){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[ch];}); }

    load().catch(err=>{
      console.error(err);
      document.getElementById('usersArea').innerHTML = '<p class="error">Unexpected error</p>';
      document.getElementById('coursesArea').innerHTML = '<p class="error">Unexpected error</p>';
    });
  </script>
</body>
</html>
